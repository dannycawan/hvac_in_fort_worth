name: Flutter Build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # üì• Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‚öôÔ∏è Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.0"
          cache: true
          cache-key: flutter-packages

      # üì¶ Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # üîë Setup Keystore (DIPERBAIKI - menggunakan secret names yang benar)
      - name: Setup Keystore
        run: |
          echo "Membuat keystore dari GitHub Secrets..."
          echo "${{ secrets.ANDROID_KEYSTORE_FILE }}" | base64 -d > android/app/my-release-key.jks
          
          echo "Membuat key.properties..."
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=my-release-key.jks
          EOF

      # üîé Debug: cek apakah file keystore & key.properties ada (DIPERBAIKI)
      - name: Debug keystore and key.properties
        run: |
          echo "=== DEBUG KEYSTORE SETUP ==="
          echo "---- Struktur folder android ----"
          find android -name "*.jks" -o -name "*.properties" | head -10
          
          echo "---- android/app ----"
          ls -la android/app/ | grep -E "(jks|keystore)" || echo "Tidak ada file keystore"
          
          echo "---- android/key.properties ----"
          if [ -f "android/key.properties" ]; then
            echo "‚úÖ key.properties ditemukan:"
            cat android/key.properties
          else
            echo "‚ùå key.properties TIDAK ditemukan!"
          fi
          
          echo "---- Verifikasi keystore ----"
          if [ -f "android/app/my-release-key.jks" ]; then
            keytool -list -v -keystore android/app/my-release-key.jks -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" || echo "‚ö†Ô∏è Gagal verifikasi keystore"
          else
            echo "‚ùå File keystore tidak ditemukan!"
          fi

      # üîß Fix permissions (DIPERBAIKI)
      - name: Fix permissions
        run: |
          sudo chmod -R 755 android
          sudo chmod 644 android/app/my-release-key.jks
          echo "‚úÖ Permissions fixed"

      # üîç Flutter doctor (TAMBAHAN - untuk troubleshooting)
      - name: Flutter doctor
        run: flutter doctor -v

      # üèóÔ∏è Build APK (Release) (DIPERBAIKI - dengan error handling)
      - name: Build APK (release)
        run: |
          flutter build apk --release --verbose
        timeout-minutes: 15

      # üèóÔ∏è Build AAB (Release) (DIPERBAIKI - dengan error handling)
      - name: Build AAB (release)
        run: |
          flutter build appbundle --release --verbose
        timeout-minutes: 15

      # üìÇ Debug: list build outputs (DIPERBAIKI)
      - name: List build outputs
        run: |
          echo "=== BUILD OUTPUTS ==="
          echo "---- Struktur build folder ----"
          find build/ -type f -name "*.apk" -o -name "*.aab" | head -20
          
          echo "---- Detail APK files ----"
          if [ -d "build/app/outputs/flutter-apk" ]; then
            ls -la build/app/outputs/flutter-apk/
            echo "üì± APK files:"
            find build/app/outputs/flutter-apk -name "*.apk"
          else
            echo "‚ùå Folder APK tidak ditemukan"
          fi
          
          echo "---- Detail AAB files ----"
          if [ -d "build/app/outputs/bundle" ]; then
            ls -la build/app/outputs/bundle/
            echo "üì¶ AAB files:"
            find build/app/outputs/bundle -name "*.aab"
          else
            echo "‚ùå Folder AAB tidak ditemukan"
          fi

      # ‚¨ÜÔ∏è Upload APK ke GitHub Actions artifact (DIPERBAIKI)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: hvac-apk-release
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/flutter-apk/app-release-*.apk
          if-no-files-found: warn
          retention-days: 7

      # ‚¨ÜÔ∏è Upload AAB ke GitHub Actions artifact (DIPERBAIKI)
      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: hvac-aab-release
          path: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/bundle/release/app-*.aab
          if-no-files-found: warn
          retention-days: 7

      # üîç Build info (DIPERBAIKI)
      - name: Build info
        if: success()
        run: |
          echo "üéâ BUILD BERHASIL!"
          echo "=================="
          echo "üì± APK Files:"
          find build/app/outputs/flutter-apk -name "*.apk" 2>/dev/null || echo "Tidak ada APK"
          echo "üì¶ AAB Files:"
          find build/app/outputs/bundle -name "*.aab" 2>/dev/null || echo "Tidak ada AAB"
          echo "=================="
          echo "‚è∞ Waktu: $(date)"